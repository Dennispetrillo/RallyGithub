<!DOCTYPE html>
<html>
<head>
    <title>RallyGithub</title>

    <script type="text/javascript" src="/apps/2.0p/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define('changeset.model.Branch', {
                extend: 'Ext.data.Model',
                fields: [
                    {name: 'commit', type: 'object'},
                    {name: 'name', type: 'string'}
                ]
            });            Ext.define('changeset.model.Commit', {
                extend: 'Ext.data.Model',
                fields: [
                    {name: 'revision', type: 'string'},
                    {name: 'url', type: 'string'},
                    {name: 'author', type: 'object'},
                    {name: 'timestamp', type: 'date'},
                    {name: 'message', type: 'string'},
                    {name: 'tree', type: 'object'},
                    {name: 'parents', type: 'array'}
                ]
            });            Ext.define('changeset.model.ChangesetFile', {
                extend: 'Ext.data.Model',
                fields: [
                    {name: 'status', type: 'string'},
                    {name: 'filename', type: 'string'},
                    {name: 'url', type: 'string'},
                    {name: 'deletions', type: 'integer'},
                    {name: 'additions', type: 'integer'},
                    {name: 'changes', type: 'integer'},
                    {name: 'diff', type: 'string'}
                ]
            });            Ext.define('changeset.data.GithubProxy', {
                extend: 'Ext.data.proxy.Rest',
            
                statics: {
                    /**
                     * Build Commit record from Github api data.
                     */
                    extractCommitValues: function(data) {
                        var output = {
                            revision: data.sha,
                            url: data.url,
                            author: data.author,
                            parents: data.parents
                        };
            
                        var commit = data.commit;
                        if (commit) {
                            Ext.apply(output, commit);
                            output.timestamp = commit.author.date;
                        }
                        return output
                    },
            
                    extractChangesetFileValues: function(data) {
                        var output = {
                            status: data.status,
                            filename: data.filename,
                            url: data.raw_url,
                            deletions: data.deletions,
                            additions: data.additions,
                            changes: data.changes,
                            diff: data.patch
                        };
                        return output;
                    }
                },
            
                stripRallyHeaders: true,
                pageParam: 'page',
                limitParam: 'per_page',
                startParam: undefined
            });            /**
             * Adapter classes contain methods to construct Store objects for use by ui components.
             */
            Ext.define('changeset.data.GithubAdapter', {
                extend: 'Ext.util.Observable',
                require: ['changeset.model.Changeset', 'changeset.data.GithubProxy'],
            
                /**
                 * @cfg
                 * Github username
                 */
                username: 'rally-dthompson',
            
                /**
                 * @cfg
                 * Github password
                 */
                password: '',
            
                /**
                 * @cfg
                 * Github repository name
                 */
                repository: 'RallyGithub',
            
                /**
                 * @cfg
                 * Branch to grab commits from
                 */
                branch: 'master',
            
                /**
                 * @cfg
                 * Base url for all Github api requests.
                 */
                apiUrl: 'https://api.github.com',
            
                /**
                 * @cfg
                 * OAuth token for Github api
                 */
                authToken: "57e6c432f1d0341be88703768399b9fb90b891f4",
            
                constructor: function(config) {
                    Ext.apply(this, config);
            
                    this.addEvents(
                        /**
                         * @event
                         * Fired when the adapter is ready to be used.
                         */
                        'ready'
                    );
            
                    this.callParent(arguments);
            
                    Ext.Ajax.on('beforerequest', this._onBeforeAjaxRequest, this);
                },
            
                /**
                 * Initializes the adapter.
                 */
                init: function(callback, scope) {
                    this.on('ready', function() {
                        callback.call(scope, this);
                    }, this, {single: true});
            
                    this._authenticate();
                },
            
                /**
                 * Return a url to the repository.
                 */
                getRepositoryUrl: function() {
                    return 'https://github.com/' + this.username + '/' + this.repository;
                },
            
                /**
                 * Constructs a store which populates branch models.
                 */
                getBranchStore: function(callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this.username,
                        this.repository,
                        'branches'
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.Branch',
                        proxy: Ext.create('changeset.data.GithubProxy', {
                            url: url
                        })
                    });
            
                    callback.call(scope, store);
                },
            
                /**
                 * Returns a store which populates commit models.
                 */
                getCommitStore: function(callback, scope) {
                    this.getBranchStore(function(store) {
                        store.on('load', function(store) {
                            this._onBranchLoad(store, callback, scope);
                        }, this, {single: true});
                        store.load();
                    }, this);
                },
            
                /**
                 * Returns a store which populates changeset models.
                 */
                getChangesetStore: function(record, callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this.username,
                        this.repository,
                        'compare',
                        record.get('parents')[0].sha + '...' + record.get('revision')
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.ChangesetFile',
                        proxy: Ext.create('changeset.data.GithubProxy', {
                            url: url,
                            reader: {
                                type: 'json',
                                root: 'files',
                                extractValues: changeset.data.GithubProxy.extractChangesetFileValues
                            }
                        })
                    });
            
                    callback.call(scope, store);
                },
            
                /**
                 * Grabs a OAuth token using the current credentials.
                 * @private
                 */
                _authenticate: function() {
                    if (!Ext.isEmpty(this.authToken)) {
                        this.fireEvent('ready', this);
                        return;
                    }
            
                    var encodedAuth = 'Basic ' + btoa(this.username + ':' + this.password);
                    Ext.Ajax.request({
                        url: this.apiUrl + '/authorizations',
                        method: 'POST',
                        stripRallyHeaders: true,
                        headers: {
                            Authorization: encodedAuth
                        },
                        jsonData: {},
                        success: function(response, opts) {
                            var data = Ext.decode(response.responseText);
                            this.authToken = data.token;
                            this.fireEvent('ready', this);
                        },
                        scope: this
                    });
                },
            
                /**
                 * Removes Rally specific headers from Ajax request options.
                 */
                _stripRallyHeaders: function(opts) {
                    if ((opts.stripRallyHeaders || (opts.scope && opts.scope.stripRallyHeaders)) && opts.headers) {
                        delete opts.headers["X-RallyIntegrationLibrary"];
                        delete opts.headers["X-RallyIntegrationName"];
                    }
                },
            
                _onBeforeAjaxRequest: function(ext, opts) {
                    this._stripRallyHeaders(opts);
                },
            
                _onBranchLoad: function(store, callback, scope) {
                    var branch = store.findRecord('name', this.branch);
            
                    var url = [
                        this.apiUrl,
                        'repos',
                        this.username,
                        this.repository,
                        'commits'
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.Commit',
                        proxy: Ext.create('changeset.data.GithubProxy', {
                            url: url,
                            extraParams: {
                                sha: branch.get('commit').sha
                            },
                            reader: {
                                type: 'json',
                                extractValues: changeset.data.GithubProxy.extractCommitValues
                            }
                        })
                    });
                    callback.call(scope, store);
                },
            
                _getChangeset: function(record, callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this.username,
                        this.repository,
                        'compare',
                        record.get('parents')[0].sha + '...' + record.get('revision')
                    ].join('/');
            
                    Ext.Ajax.request({
                        url: url,
                        method: 'GET',
                        stripRallyHeaders: true,
                        jsonData: {},
                        success: function(response, opts) {
                            var data = Ext.decode(response.responseText);
                            callback.call(scope, data)
                        },
                        scope: this
                    });
                }
            });            Ext.define('changeset.ui.ChangesetGrid', {
                extend: 'Rally.ui.grid.Grid',
                require: ['Rally.util.Navigation'],
                alias: 'widget.changesetgrid',
                cls: 'changeset-grid',
            
                /**
                 * @cfg
                 * Artifact type prefix regexes to match in commit messages.
                 */
                artifactRegexes: [
                    /(\s+)(DE\d+)/,
                    /(\s+)(US\d+)/,
                    /(\s+)(TA\d+)/
                ],
            
                columnCfgs: [
                    {
                        header: 'Message',
                        dataIndex: 'message',
                        itemId: 'messageCol',
                        flex: 1,
                        renderer: function(value) {
                            Ext.each(this.artifactRegexes, function(artifactRegex) {
                                value = value.replace(artifactRegex, '<a href="#" class="artifact-link">$1$2</a>');
                            });
                            return value;
                        }
                    },
                    {
                        xtype: 'templatecolumn',
                        header: 'Author',
                        tpl: '{author.name}',
                        flex: .3
                    },
                    {
                        xtype: 'datecolumn',
                        header: 'Commit Time',
                        dataIndex: 'timestamp',
                        format: 'Y-m-d h:i:s A',
                        width: 140
                    },
                    {
                        header: 'Revision',
                        dataIndex: 'revision',
                        renderer: function(value) {
                            return Ext.String.format('<a href="#" class="revision-link">{0}</a>', value);
                        },
                        width: 85
                    }
                ],
            
                constructor: function(config) {
                    config = config || {};
                    Ext.applyIf(config, {
                        columnCfgs: this.columnCfgs
                    });
                    this.callParent([config]);
                },
            
                initComponent: function() {
                    this.callParent(arguments);
                    this.addEvents(
                        /**
                         * @event
                         * fired when a revision is clicked.
                         */
                        'revisionClicked',
                        /**
                         * @event
                         * fired when an artifact is clicked.
                         */
                        'artifactClicked'
                    );
            
                    this.on('render', this._onRender, this);
                },
            
                _onRender: function() {
                    var el = this.getEl();
                    el.on('click', this._onArtifactClick, this, {delegate: 'a.artifact-link'});
                    el.on('click', this._onRevisionClick, this, {delegate: 'a.revision-link'});
                },
            
                _onArtifactClick: function(event, dom, opts) {
                    this.fireEvent('artifactClicked', dom.innerHTML);
                },
            
                _onRevisionClick: function(event, dom) {
                    var record = this.store.findRecord('revision', dom.innerHTML);
                    this.fireEvent('revisionClicked', record);
                }
            });            Ext.define('changeset.ui.ChangesetFilesGrid', {
                extend: 'Rally.ui.grid.Grid',
                alias: 'widget.changesetfilesgrid',
                cls: 'changeset-files-grid',
                storeConfig: {
                    fetch: true,
                    sorters: [{
                        property: 'filename',
                        direction: 'ASC'
                    }]
                },
                columnCfgs: [{
                    header: 'Status',
                    dataIndex: 'status',
                    renderer: function(value) {
                        return Ext.String.capitalize(value.substring(0,3));
                    },
                    width: 50
                },{
                    header: 'File',
                    xtype: 'templatecolumn',
                    tpl: '<a href="{url}">{filename}</a>',
                    flex: 1
                },{
                    header: 'Changes',
                    dataIndex: 'changes',
                    width: 60
                },{
                    header: 'Additions',
                    dataIndex: 'additions',
                    width: 60
                },{
                    header: 'Deletions',
                    dataIndex: 'deletions',
                    width: 60
                }],
            
                constructor: function(config) {
                    config = config || {};
                    Ext.applyIf(config, {
                        columnCfgs: this.columnCfgs,
                        storeConfig: this.storeConfig
                    });
            
                    this.callParent([config]);
                }
            });            Ext.define('changeset.ui.ChangesetSummary', {
                extend: 'Ext.panel.Panel',
                alias: 'widget.changesetsummary',
                cls: 'changeset-summary',
                frame: true,
                dockedItems: [{
                    xtype: 'toolbar',
                    itemId: 'bottomToolbar',
                    dock: 'bottom',
                    border: 0
                }],
            
                initComponent: function() {
                    this.callParent(arguments);
                    this._initItems();
                },
                
                _initItems: function() {
                    if (!this.record) {
                        return;
                    }
            
                    this.html = '<p>' + this.record.get('message') + '</p>';
            
                    this.getComponent('bottomToolbar').add([
                        {
                            html: this.record.get('author').name
                        },
                        {
                            html: Ext.Date.format(new Date(this.record.get('timestamp')), 'Y-m-d h:i:s A')
                        },
                        {
                            html: this.record.get('revision')
                        }
                    ]);
                }
            });            Ext.define('changeset.ui.Changeset', {
                extend: 'Ext.panel.Panel',
                require: ['changeset.ui.ChangesetSummary'],
                alias: 'widget.changeset',
                cls: 'changeset',
            
                /**
                 * @cfg
                 * Adapter to use for retrieving data.
                 */
                adapter: null,
            
                initComponent: function() {
                    this.callParent(arguments);
                    this.on('afterrender', this._onAfterRender, this, {single: true});
                },
            
                _loadChangesetStore: function() {
                    this.adapter.getChangesetStore(this.record, function(store) {
                        this.mon(store, 'load', this._onChangesetStoreLoad, this, {single: true});
                        store.load();
                    }, this);
                },
            
                _onChangesetStoreLoad: function(store) {
                    var grid = this.insert( 1,
                        {
                            xtype: 'changesetfilesgrid',
                            margin: 10,
                            border: 0,
                            store: store
                        }
                    );
                },
            
                _renderChangeset: function() {
                    if (!this.record) {
                        return;
                    }
            
                    this.add({
                        xtype: 'changesetsummary',
                        margin: 10,
                        border: 0,
                        record: this.record
                    });
            
                    this._loadChangesetStore();
                },
            
                _onAfterRender: function() {
                    this._renderChangeset();
                }
            });            Ext.define('changeset.ui.ChangesetBrowser', {
                extend: 'Ext.panel.Panel',
                alias: 'widget.changesetbrowser',
                require: ['changeset.ui.ChangesetGrid', 'changeset.ui.Changeset'],
                cls: 'changeset-browser',
                layout: {
                    type: 'accordion',
                    animate: true
                },
            
                /**
                 * @cfg
                 * Adapter to use for retrieving data.
                 */
                adapter: null,
            
                initComponent: function() {
                    this.callParent(arguments);
                    this._addGrid();
                },
            
                _addGrid: function() {
                    this.adapter.getCommitStore(function(store) {
                        var grid = this.add(
                            {
                                xtype: 'changesetgrid',
                                margin: '10 0 0 0',
                                autoScroll: true,
                                model: 'changeset.model.Commit',
                                store: store
                            }
                        );
                        grid.setTitle('Commits');
                        grid.getStore().load();
                        this.mon(grid, 'artifactClicked', this._showArtifact, this);
                        this.mon(grid, 'revisionClicked', this._showRevision, this);
                    }, this);
                },
            
                _showArtifact: function(formattedId) {
                    Ext.data.JsonP.request({
                        url: Rally.environment.getServer().getWsapiUrl() + '/artifact.js',
                        method: 'GET',
                        callbackKey: 'jsonp',
                        params: {
                            query: '(FormattedID = ' + formattedId + ')'
                        },
                        success: this._onFormattedIdLoad,
                        scope: this
                    });
                },
            
                _onFormattedIdLoad: function(result) {
                    if (result.QueryResult) {
                        var results = result.QueryResult.Results;
                        if (results && results.length) {
                            var ref = results[0]._ref;
                            var detailLink = Rally.util.Navigation.createRallyDetailUrl(ref);
                            window.open(detailLink, 'detailpage');
                        }
                    }
                },
            
                _showRevision: function(record) {
                    if (this.items.getCount() > 1) {
                        this.remove(this.items.getAt(1));
                    }
                    var revision = this.add({
                        xtype: 'changeset',
                        adapter: this.adapter,
                        title: 'Revision: ' + record.get('revision'),
                        autoScroll: true,
                        record: record
                    });
                    revision.expand();
                }
            });            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                require: ['changeset.data.GithubAdapter', 'changeset.ui.ChangesetBrowser'],
                componentCls: 'app',
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
            
                launch: function() {
                    var adapter = Ext.create('changeset.data.GithubAdapter');
                    adapter.init(this._onAdapterInit, this);
                },
            
                _onAdapterInit: function(adapter) {
                    this.add({
                        html: 'Repository: <a href="' + adapter.getRepositoryUrl() + '" target="_blank">' + adapter.repository + '</a>',
                        margin: '5 5 0 5',
                        border: 0
                    });
            
                    this.add({
                        xtype: 'changesetbrowser',
                        margin: '0 5 5 5',
                        border: 0,
                        adapter: adapter,
                        flex: 1
                    });
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'RallyGithub'
            });
        });
    </script>

    <style type="text/css">
        .changeset-browser-title .x-panel-body {
            font-size: 18px;
        }        .changeset-files-grid .x-panel-body {
            border-bottom: 1px solid #999;
            border-top: 1px solid #999 !important;
        }
        .changeset-summary, .changeset-summary .x-panel-body {
            background-color: #eee;
        }
        
        .changeset-summary {
            border-color: #999;
        }
        
        .changeset-summary p {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .changeset-summary .x-toolbar-docked-bottom {
            border: 0;
            background-color: transparent;
        }
        
        .changeset-summary .x-toolbar-docked-bottom .x-toolbar-item {
            background-color: #aaa;
        }
        
        .changeset-summary .x-toolbar-docked-bottom .x-toolbar-item:hover {
            cursor: default;
        }        .app {
             /* Add app styles here */
        }
    </style>
</head>
<body></body>
</html>
