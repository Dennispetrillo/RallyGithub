<!DOCTYPE html>
<html>
<head>
    <title>RallyGithub</title>

    <script type="text/javascript" src="/apps/2.0p/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define('changeset.model.Branch', {
                extend: 'Ext.data.Model',
                idProperty: 'name',
                fields: [
                    {name: 'commit', type: 'object'},
                    {name: 'name', type: 'string'}
                ]
            });            Ext.define('changeset.model.Comment', {
                extend: 'Ext.data.Model',
                fields: [
                    {name: 'revision', type: 'string'},
                    {name: 'filename', type: 'string'},
                    {name: 'lineNumber', type: 'string'},
                    {name: 'user', type: 'object'},
                    {name: 'avatarUrl', type: 'string'},
                    {name: 'comment', type: 'string'},
                    {name: 'timestamp', type: 'date'}
                ]
            });            Ext.define('changeset.model.Commit', {
                extend: 'Ext.data.Model',
                idProperty: 'revision',
                fields: [
                    {name: 'revision', type: 'string'},
                    {name: 'url', type: 'string'},
                    {name: 'author', type: 'object'},
                    {name: 'avatarUrl', type: 'string'},
                    {name: 'timestamp', type: 'date'},
                    {name: 'message', type: 'string'},
                    {name: 'tree', type: 'object'},
                    {name: 'parents', type: 'array'}
                ]
            });            Ext.define('changeset.model.ChangesetFile', {
                extend: 'Ext.data.Model',
                fields: [
                    {name: 'status', type: 'string'},
                    {name: 'filename', type: 'string'},
                    {name: 'url', type: 'string'},
                    {name: 'deletions', type: 'integer'},
                    {name: 'additions', type: 'integer'},
                    {name: 'changes', type: 'integer'},
                    {name: 'diff', type: 'string'}
                ]
            });            Ext.define('changeset.model.Repository', {
                extend: 'Ext.data.Model',
                idProperty: 'name',
                fields: [
                    {name: 'url', type: 'string'},
                    {name: 'name', type: 'string'}
                ]
            });            /**
             * Lookup comment records by path and line number.
             */
            Ext.define('changeset.data.CommentLocator', {
            
                /**
                 * @param {Ext.data.Store} store A store that loads {changeset.model.Comment} records.
                 */
                constructor: function(store) {
                    this.comments = this._getKeyedComments(store);
                },
                
                /**
                 * Returns comments that are located at a specific diff line.
                 * 
                 * @param {String} path File path.
                 * @param {String|Int} lineNumber Line number.
                 * @return {Array} of {changeset.model.Comment}
                 */
                getComments: function(path, lineNumber) {
                    var key = this._getCommentKey(path, lineNumber);
                    return this.comments[key] || null;
                },
                
                _getCommentKey: function(path, lineNumber) {
                    return path + ':' + lineNumber.toString();
                },
                
                _getKeyedComments: function(store) {
                    var comments = {};
                    store.each(function(record) {
                        var key = this._getCommentKey(record.get('filename'), record.get('lineNumber'));
                        if (!comments.hasOwnProperty(key)) {
                            comments[key] = [];
                        }
                        comments[key].push(record);
                    }, this);
                    return comments;
                }
            });            Ext.define('changeset.data.github.Proxy', {
                extend: 'Ext.data.proxy.Rest',
            
                statics: {
                    // extract functions are used to normalize data objects coming in from the server
                    extractCommitValues: function(data) {
                        var output = {
                            revision: data.sha,
                            url: data.url,
                            author: data.author,
                            avatarUrl: data.author ? data.author.avatar_url : null,
                            parents: data.parents
                        };
            
                        var commit = data.commit;
                        if (commit) {
                            Ext.apply(output, commit);
                            output.timestamp = commit.author.date;
                        }
                        return output;
                    },
            
                    extractChangesetFileValues: function(data) {
                        var output = {
                            status: data.status,
                            filename: data.filename,
                            url: data.raw_url,
                            deletions: data.deletions,
                            additions: data.additions,
                            changes: data.changes,
                            diff: data.patch
                        };
                        return output;
                    },
                    
                    extractCommentValues: function(data) {
                        var output = {
                            revision: data.commit_id,
                            filename: data.path,
                            lineNumber: data.position,
                            comment: data.body,
                            timestamp: data.created_at,
                            user: data.user,
                            avatarUrl: data.user ? data.user.avatar_url : null
                        };
                        return output;
                    }
                },
            
                cors: true,
                stripRallyHeaders: true,
                pageParam: 'page',
                limitParam: 'per_page',
                startParam: undefined
            });            /**
             * Adapter classes contain methods to construct Store objects for use by ui components.
             */
            Ext.define('changeset.data.github.Adapter', {
                require: [
                    'changeset.model.Changeset',
                    'changeset.model.Comment',
                    'changeset.data.github.Proxy',
                    'changeset.data.github.CommitStore'
                ],
                mixins: {
                    observable: 'Ext.util.Observable',
                    stateful: 'Ext.state.Stateful'
                },
            
                /**
                 * @cfg {String}
                 * Github username
                 */
                username: null,
            
                /**
                 * @cfg {changeset.model.Repository}
                 * @private
                 * Github repository
                 */
                repository: null,
            
                /**
                 * @cfg {String}
                 * @private
                 * OAuth token for Github api
                 */
                authToken: null,
            
                /**
                 * @cfg {changeset.model.Branch}
                 * Branch to grab commits from
                 * @private
                 */
                branch: null,
            
                /**
                 * @cfg {String}
                 * Base url for all Github api requests.
                 */
                apiUrl: 'https://api.github.com',
                
                /**
                 * @cfg {Int}
                 * Page size to use for api calls.
                 */
                pageSize: 100,
            
                // these configs setup statefullness
                stateful: true,
                stateEvents: ['ready', 'statechange'],
                stateId: window.location.href + 'githubAdapter',
            
                constructor: function(config) {
                    Ext.apply(this, config);
            
                    this.addEvents(
                        /**
                         * @event
                         * Fired when the adapter is ready to be used.
                         * @param {changeset.data.github.Adapter}
                         */
                        'ready',
                        /**
                         * @event
                         * Fired when the adapter needs authentication.
                         * @param {changeset.data.github.Adapter}
                         */
                        'authenticationrequired',
                        /**
                         * @event
                         * Fired when the state needs to be saved.
                         * @param {changeset.data.github.Adapter}
                         */
                        'statechange'
                    );
            
                    this.mixins.observable.constructor.apply(this, arguments);
                    this.mixins.stateful.constructor.apply(this, arguments);
            
                    Ext.Ajax.on('beforerequest', this._onBeforeAjaxRequest, this);
                    Ext.Ajax.on('requestexception', this._onAjaxRequestException, this);
            
                    this._init();
                },
            
                /**
                 * Get the current state.
                 * @return {Object}
                 */
                getState: function() {
                    return {
                        username: this.username,
                        authToken: this.authToken,
                        repository: this.repository,
                        branch: this.branch
                    };
                },
            
                /**
                 * Get an appropriate login message
                 * @return {String}
                 */
                getLoginMessage: function() {
                    return 'Login to your GitHub account';
                },
            
                /**
                 * Return a url to the repository.
                 * @return {String}
                 */
                getRepositoryUrl: function() {
                    return 'https://github.com/' + this._getRepoPath();
                },
            
                /*
                 * Gets the currently selected repository.
                 * @return {Object}
                 */
                getRepository: function() {
                    return this.repository;
                },
            
                /*
                 * Set the repository to fetch data from.
                 * @param {changeset.model.Repository}
                 */
                setRepository: function(repository) {
                    if( !this.repository || this.repository.name !== repository.raw.name ) {
                        this.branch = null;
                    }
                    this.repository = repository.raw;
                    this.fireEvent('statechange', this);
                },
            
                /*
                 * Gets the currently selected branch.
                 * @return {Object}
                 */
                getBranch: function() {
                    return this.branch;
                },
            
                /*
                 * Set the branch to fetch data from.
                 * @param {changeset.model.Branch}
                 */
                setBranch: function(branch) {
                    this.branch = branch.raw;
                    this.fireEvent('statechange', this);
                },
            
                /**
                 * Constructs a store which populates repository models.
                 * @param {Function} callback Function to call after store is created.
                 * @param {Object} scope Scope to execute callback with.
                 */
                getRepositoryStore: function(callback, scope) {
                    var url = [
                        this.apiUrl,
                        'user',
                        'repos'
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.Repository',
                        proxy: Ext.create('changeset.data.github.Proxy', {
                            url: url
                        })
                    });
            
                    callback.call(scope, store);
                },
            
                /**
                 * Constructs a store which populates branch models.
                 * @param {Function} callback Function to call after store is created.
                 * @param {Object} scope Scope to execute callback with.
                 */
                getBranchStore: function(callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this._getRepoPath(),
                        'branches'
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.Branch',
                        proxy: Ext.create('changeset.data.github.Proxy', {
                            url: url
                        })
                    });
            
                    callback.call(scope, store);
                },
            
                /**
                 * Returns a store which populates commit models.
                 * @param {Function} callback Function to call after store is created.
                 * @param {Object} scope Scope to execute callback with.
                 */
                getCommitStore: function(callback, scope) {
                    this.getBranchStore(function(store) {
                        store.on('load', function(store) {
                            this._onBranchLoad(store, callback, scope);
                        }, this, {single: true});
                        store.load();
                    }, this);
                },
            
                /**
                 * Returns a store which populates changeset models.
                 * @param {changeset.model.Commit} record Commit to get changeset for.
                 * @param {Function} callback Function to call after store is created.
                 * @param {Object} scope Scope to execute callback with.
                 */
                getChangesetStore: function(record, callback, scope) {
                    if (record.get('parents').length < 1) {
                        callback.call(scope, null);
                        return;
                    }
            
                    var url = [
                        this.apiUrl,
                        'repos',
                        this._getRepoPath(),
                        'compare',
                        record.get('parents')[0].sha + '...' + record.get('revision')
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.ChangesetFile',
                        proxy: Ext.create('changeset.data.github.Proxy', {
                            url: url,
                            reader: {
                                type: 'json',
                                root: 'files',
                                extractValues: changeset.data.github.Proxy.extractChangesetFileValues
                            }
                        })
                    });
            
                    callback.call(scope, store);
                },
                
                /**
                 * Returns a store which populates comment models.
                 * @param {changeset.model.Commit} record Commit record to retrieve comments for.
                 * @param {Function} callback Function to call after store is created.
                 * @param {Object} scope Scope to execute callback with.
                 */
                getCommentStore: function(record, callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this._getRepoPath(),
                        'commits',
                        record.get('revision'),
                        'comments'
                    ].join('/');
            
                    var store = Ext.create('Ext.data.Store', {
                        model: 'changeset.model.Comment',
                        pageSize: this.pageSize,
                        proxy: Ext.create('changeset.data.github.Proxy', {
                            url: url,
                            reader: {
                                type: 'json',
                                extractValues: changeset.data.github.Proxy.extractCommentValues
                            }
                        })
                    });
                    
                    callback.call(scope, store);
                },
            
                /**
                 * Saves a comment
                 * 
                 * @param data {Object} The comment data to save
                 * @param callback {Function} The callback to be executed when the save is complete.
                 * @param scope {Object} The scope to execute the callback in.
                 */
                saveComment: function(data, callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this._getRepoPath(),
                        'commits',
                        data.revision,
                        'comments'
                    ].join('/');
            
                    Ext.Ajax.request({
                        url: url,
                        method: 'POST',
                        stripRallyHeaders: true,
                        jsonData: {
                            body: data.comment,
                            commit_id: data.revision,
                            line: data.lineIdx,
                            path: data.filename,
                            position: data.diffIdx
                        },
                        success: function(response, opts) {
                            if (callback) {
                                var data = Ext.decode(response.responseText);
                                var record = new changeset.model.Comment(changeset.data.github.Proxy.extractCommentValues(data));
                                callback.call(scope, record);
                            }
                        },
                        scope: this
                    });
                },
            
                /**
                 * Grabs an OAuth token using the passed credentials.
                 * If this is successful, it will fire the 'ready' event,
                 * if it fails, it will fire  the 'authenticationrequired' event.
                 * 
                 * @param {String} username Username to login with.
                 * @param {String} password Password to login with.
                 */
                authenticate: function(username, password) {
                    this.username = username;
            
                    Ext.Ajax.request({
                        url: this.apiUrl + '/authorizations',
                        method: 'GET',
                        stripRallyHeaders: true,
                        headers: {
                            Authorization: this._getBasicAuth(password)
                        },
                        success: function(response, opts) {
                            var data = Ext.decode(response.responseText);
                            var tokenLength = data.length;
                            for (var i = 0; i < tokenLength; i++) {
                                var token = data[i];
                                if (token.note === 'RallyGithub') {
                                    this.authToken = token.token;
                                    this.fireEvent('ready', this);
                                    return;
                                }
                            }
                            this._getNewToken(password);
                        },
                        failure: function(response, opts) {
                            this.fireEvent('authenticationrequired', this);
                        },
                        scope: this
                    });
                },
            
                /**
                 * Logs user out of github api.
                 * 
                 * Fires 'authenticationrequired'.
                 */
                logout: function() {
                    this.repository = null;
                    this.branch = null;
                    this.username = null;
                    this.authToken = null;
                    Ext.state.Manager.getProvider().clear(this.getStateId());
                    this.fireEvent('authenticationrequired', this);
                },
            
                /**
                 * Returns basic authentication details.
                 */
                _getBasicAuth: function(password) {
                    return 'Basic ' + btoa(this.username + ':' + password);
                },
            
                /**
                 * Creates and uses a new OAuth token.
                 */
                _getNewToken: function(password) {
                    Ext.Ajax.request({
                        url: this.apiUrl + '/authorizations',
                        method: 'POST',
                        stripRallyHeaders: true,
                        headers: {
                            Authorization: this._getBasicAuth(password)
                        },
                        jsonData: {
                            note: 'RallyGithub',
                            scopes: ['public_repo', 'repo']
                        },
                        success: function(response, opts) {
                            var data = Ext.decode(response.responseText);
                            this.authToken = data.token;
                            this.fireEvent('ready', this);
                        },
                        failure: function(response, opts) {
                            this.fireEvent('authenticationrequired', this);
                        },
                        scope: this
                    });
                },
            
                /**
                 * Removes Rally specific headers from Ajax request options.
                 */
                _stripRallyHeaders: function(opts) {
                    if ((opts.stripRallyHeaders || (opts.scope && opts.scope.stripRallyHeaders)) && opts.headers) {
                        delete opts.headers["X-RallyIntegrationLibrary"];
                        delete opts.headers["X-RallyIntegrationName"];
                    }
                },
            
                _getRepoPath: function() {
                    return this.repository.owner.login + '/' + this.repository.name;
                },
            
                _init: function() {
                    if (!Ext.isEmpty(this.authToken)) {
                        this.fireEvent('ready', this);
                    } else {
                        this.fireEvent('authenticationrequired', this);
                    }
                },
            
                _onBeforeAjaxRequest: function(ext, opts) {
                    this._stripRallyHeaders(opts);
            
                    if (!opts.headers.hasOwnProperty('Authorization') && this.authToken) {
                        opts.headers.Authorization = 'token ' + this.authToken;
                    }
                },
            
                _onAjaxRequestException: function(conn, response, options, eOpts) {
                    if (response.status === 401) {
                        this.fireEvent('authenticationrequired', this);
                    }
                },
            
                _onBranchLoad: function(store, callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this._getRepoPath(),
                        'commits'
                    ].join('/');
            
                    var commitStore = Ext.create('changeset.data.github.CommitStore', {
                        startSha: this.branch.commit.sha,
                        pageSize: this.pageSize,
                        clearOnPageLoad: false,
                        filterOnLoad: false,
                        proxy: Ext.create('changeset.data.github.Proxy', {
                             url: url,
                             reader: {
                                 type: 'json',
                                 extractValues: changeset.data.github.Proxy.extractCommitValues
                             }
                         })
                    });
            
                    callback.call(scope, commitStore);
                },
            
                _getChangeset: function(record, callback, scope) {
                    var url = [
                        this.apiUrl,
                        'repos',
                        this._getRepoPath(),
                        'compare',
                        record.get('parents')[0].sha + '...' + record.get('revision')
                    ].join('/');
            
                    Ext.Ajax.request({
                        url: url,
                        method: 'GET',
                        stripRallyHeaders: true,
                        jsonData: {},
                        success: function(response, opts) {
                            var data = Ext.decode(response.responseText);
                            callback.call(scope, data);
                        },
                        scope: this
                    });
                }
            });            /**
             * Store for loading {changeset.model.Commit} records from Github.
             */
            Ext.define('changeset.data.github.CommitStore', {
                extend: 'Ext.data.Store',
                require: [
                    'changeset.model.Commit',
                    'changeset.data.github.Proxy'
                ],
            
                model: 'changeset.model.Commit',
            
                /**
                 * Github's commit endpoint's paging is a little funky.
                 *
                 * You must specify a sha to page to,
                 * instead of a normal page number.
                 */
                loadPage: function(page, options) {
                    this._addShaToOptions(page);
                    var result = this.callParent(arguments);
                    return result;
                },
            
                /**
                 * Overridden to remove duplicate row that comes back
                 * because of API's funky paging.
                 * @private
                 */
                onProxyLoad: function(operation) {
                    if (operation && operation.page > 1 && operation.resultSet) {
                        var resultSet = operation.resultSet;
                        if (resultSet.records && resultSet.records.length > 0) {
                            resultSet.records.shift();
                            resultSet.count--;
                            resultSet.total--;
                            resultSet.totalRecords--;
                        }
                    }
                    return this.callParent(arguments);
                },
            
                _addShaToOptions: function(page) {
                    if (this.proxy) {
                        var sha,
                            data = this.snapshot || this.data;
                        if (page === 1) {
                            sha = this.startSha;
                        } else {
                            var lastCommit = data.getAt(data.getCount() - 1);
                            sha = lastCommit.get('revision');
                        }
            
                        if (!this.proxy.extraParams) {
                            this.proxy.extraParams = {};
                        }
                        this.proxy.extraParams.sha = sha;
                    }
                }
            });            Ext.define('changeset.ui.AddComment', {
                extend: 'Ext.form.Panel',
                alias: 'widget.addcomment',
                cls: 'changeset-add-comment',
                frame: true,
                height: 135,
                layout: 'anchor',
                defaults: {
                    anchor: '100%'
                },
            
                adapter: null,
            
                items: [{
                    xtype: 'textarea',
                    name: 'comment',
                    allowBlank: false,
                    height: 90
                }],
            
                buttonAlign: 'center',
                buttons: [{
                    xtype: 'rallybutton',
                    itemId: 'SubmitButton',
                    text: 'Save'
                }, {
                    xtype: 'rallybutton',
                    itemId: 'CancelButton',
                    ui: 'link',
                    text: 'Cancel'
                }],
            
                initComponent: function() {
                    this.callParent(arguments);
            
                    this.addEvents([
                        /**
                         * @event
                         * fired when comment requires persisting.
                         * @param {Ext.Component}
                         * @param {String}
                         */
                        'save',
                        /**
                         * @event
                         * fired when comment edit is canceled.
                         * @param {Ext.Component}
                         */
                        'cancel'
                    ]);
            
                    this.mon(this.down('#SubmitButton'), 'click', this._onSubmitClick, this);
                    this.mon(this.down('#CancelButton'), 'click', this._onCancelClick, this);
                },
            
                _onSubmitClick: function() {
                    if (this.getForm().isValid()) {
                        var values = this.getValues();
                        this.fireEvent('save', this, values.comment);
                    }
                },
            
                _onCancelClick: function() {
                    this.fireEvent('cancel', this);
                }
            });            Ext.define('changeset.ui.Avatar', {
                extend: 'Ext.Component',
                alias: 'widget.changesetavatar',
                cls: 'changeset-avatar',
                frame: true,
                border: 0,
                bodyBorder: false,
            
                listeners: {
                    afterrender: function(cmp) {
                        var avatarUrl = this.record.get('avatarUrl');
                        if (!Ext.isEmpty(avatarUrl)) {
                            avatarUrl += '&s=' + this.getWidth().toString();
                            cmp.getEl().setStyle('background-image', 'url(' + avatarUrl + ')');
                        }
                    }
                }
            });            Ext.define('changset.ui.Login', {
                extend: 'Ext.form.Panel',
                alias: 'widget.changesetlogin',
                cls: 'changeset-login',
                width: 300,
                height: 135,
                layout: 'anchor',
                defaults: {
                    anchor: '100%'
                },
            
                adapter: null,
            
                items: [{
                    xtype: 'textfield',
                    fieldLabel: 'Username',
                    name: 'username',
                    allowBlank: false
                },{
                    xtype: 'textfield',
                    fieldLabel: 'Password',
                    name: 'password',
                    inputType: 'password',
                    allowBlank: false
                }],
            
                buttonAlign: 'center',
                buttons: [{
                    xtype: 'rallybutton',
                    text: 'Login',
                    itemId: 'LoginButton'
                }],
            
                initComponent: function() {
                    this.callParent(arguments);
                    this.insert(0, {
                        html: '<span class="login-message">' + this.adapter.getLoginMessage() + '</span>',
                        border: 0,
                        margin: '0 0 20 0'
                    });
            
                    this.mon(this.down('#LoginButton'), 'click', this._onSubmit, this);
                    Ext.each(this.query('textfield'), function(textfield) {
                        textfield.on('specialkey', function(field, evt) {
                            if (evt.getKey() === evt.ENTER) {
                                this._onSubmit();
                            }
                        }, this);
                    }, this);
                },
            
                _onSubmit: function() {
                    if (this.getForm().isValid()) {
                        var values = this.getValues();
                        this.adapter.authenticate(values.username, values.password);
                    }
                }
            });            Ext.define('changset.ui.ChangesetFilter', {
                extend: 'Ext.form.Panel',
                alias: 'widget.changesetfilter',
                cls: 'changeset-filter',
                border: 0,
                layout: 'hbox',
            
                items: [{
                    xtype: 'textfield',
                    itemId: 'FilterText',
                    name: 'filtertext',
                    width: 150
                },{
                    xtype: 'rallybutton',
                    itemId: 'FilterButton',
                    text: 'Filter',
                    margin: '0 0 0 4'
                }],
            
                constructor: function() {
                    this.callParent(arguments);
            
                    this.addEvents([
                        /**
                         * @event
                         * fired when the filter button is clicked.
                         * @param {String}
                         */
                        'filter'
                    ]);
                },
            
                initComponent: function() {
                    this.callParent(arguments);
            
                    this.mon(this.down('#FilterButton'), 'click', this._onSubmit, this, {});
                    this.mon(this.down('#FilterText'), 'specialkey', function(field, evt) {
                        if (evt.getKey() === evt.ENTER) {
                            this._onSubmit();
                        }
                    }, this);
                },
            
                _onSubmit: function() {
                    var value = Ext.String.escape(this.down('#FilterText').getValue());
                    this.fireEvent('filter', value);
                }
            });            Ext.define('changeset.ui.ChangesetFileDiff', {
                extend: 'Ext.panel.Panel',
                require: ['changeset.ui.ChangesetSummary', 'changeset.ui.AddComment'],
                alias: 'widget.changesetfilediff',
                cls: 'changeset-file-diff',
                bodyBorder: false,
                dockedItems: [{
                    xtype: 'toolbar',
                    itemId: 'topToolbar',
                    dock: 'top'
                }],
            
                /**
                 * @cfg
                 * @private
                 * 
                 * Regex used to parse unified diff delimiter.
                 */
                unifiedDiffRegex: /^@@\s\-(\d+)(,\d+)?\s(\d+)(,\d+)?\s@@/,
                
                /**
                 * @cfg {changeset.data.CommentLocator}
                 * 
                 * Used to find comments that need to be rendered at a specific line.
                 */
                commentLocator: null,
            
                initComponent: function() {
                    this.callParent(arguments);
                    var link = Ext.String.format('<a href="{0}" class="changeset-file">{1}</a>',
                        this.record.get('url'), this.record.get('filename'));
                    this.getComponent('topToolbar').add([
                        {
                            html: link,
                            listeners: {
                                afterrender: function(cmp) {
                                    cmp.getEl().down('.changeset-file').on('click', function(evt) {
                                        evt.stopEvent();
                                        window.open(this.record.get('url'), 'changesetFile');
                                    }, this);
                                },
                                scope: this
                            },
                            flex: 1
                        }
                    ]);
            
                    var source = this._renderSourceTable();
                    this.add({
                        html: source[0],
                        autoScroll: true,
                        border: 0,
                        listeners: {
                            afterrender: function(cmp) {
                                Ext.each(source[1], function(commentConfig){
                                    Ext.apply(commentConfig, {width: this._getCommentWidth()});
                                    Ext.create('changeset.ui.ChangesetSummary', commentConfig);
                                }, this);
            
                                cmp.getEl().on('mouseover', this._onLineOver, this, {delegate: '.line-code'});
                            },
                            scope: this
                        }
                    });
                },
            
                _renderSourceTable: function() {
                    var diffLines = this.record.get('diff').split("\n");
                    if (diffLines[diffLines.length - 1] === "\ No newline at end of file") {
                        diffLines.pop();
                    }
                    var lineDetails,
                        commentConfigs = [],
                        tableBody = ['<table><tbody>'];
                    Ext.each(diffLines, function(line, lineIdx) {
                        if (!line) {
                            return;
                        }
                        lineDetails = this._getLineDetails(line, lineDetails);
                        tableBody.push(this._renderDiffLine(line, lineIdx, lineDetails));
                        var lineComment = this._renderDiffLineComment(lineIdx, commentConfigs);
                        if (!Ext.isEmpty(lineComment)) {
                            tableBody.push(lineComment);
                        }
                    }, this);
                    tableBody.push('</tbody></table>');
                    return [tableBody.join("\n"), commentConfigs];
                },
                
                _renderDiffLine: function (line, lineIdx, lineDetails) {
                    var row = [Ext.String.format('<tr class="{0} diff-idx-{1}">', lineDetails.lineCls, lineIdx)];
                    row.push(Ext.String.format('<th>{0}</th>', lineDetails.oldLineSymbol));
                    row.push(Ext.String.format('<th>{0}</th>', lineDetails.newLineSymbol));
                    row.push(Ext.String.format('<td><div class="line-wrapper"><pre class="prettyprint">{0}</pre></div></td>',
                        Ext.htmlEncode(line)));
                    row.push('</tr>');
                    return row.join('');
                },
                
                _renderDiffLineComment: function(lineIdx, commentConfigs) {
                    var comments = this.commentLocator.getComments(
                        this.record.get('filename'), lineIdx);
                    
                    if (!comments) {
                        return null;
                    }
                    
                    var commentRows = [];
                    Ext.each(comments, function(comment, idx) {
                        var commentId = this.record.get('filename') + '-' + lineIdx + '-' + idx,
                            row = [Ext.String.format('<tr class="line-comment" >')];
                        row.push('<th colspan="2">comment</th>');
                        row.push(Ext.String.format('<td><div id="{0}" class="changeset-comment"></div></td>', commentId));
                        row.push('</tr>');
                        commentRows.push(row.join(''));
            
                        commentConfigs.push({
                            renderTo: commentId,
                            record: comment,
                            messageField: 'comment',
                            userField: 'user',
                            userNameField: 'login',
                            revisionField: 'filename'
                        });
                    }, this);
                    return commentRows.join('\n');
                },
            
                _getLineDetails: function(line, lineDetails) {
                    var diffMatch = this.unifiedDiffRegex.exec(line);
                    if (diffMatch) {
                        lineDetails = {
                            oldLineNumber: parseInt(diffMatch[1], 10),
                            newLineNumber: parseInt(diffMatch[3], 10),
                            oldLineSymbol: 'old',
                            newLineSymbol: 'new',
                            lineCls: 'line-diff'
                        };
                    } else {
                        var lineType = this._getLineType(line);
                        if (lineType === '+') {
                            this._getChangeDetail(lineDetails, false, true);
                        } else if (lineType === '-') {
                            this._getChangeDetail(lineDetails, true, false);
                        } else {
                            this._getChangeDetail(lineDetails, true, true);
                        }
                    }
            
                    return lineDetails;
                },
            
                _getChangeDetail: function(lineDetails, incrementOld, incrementNew) {
                    lineDetails.lineCls = 'line-equal';
            
                    if (incrementOld) {
                        lineDetails.oldLineSymbol = lineDetails.oldLineNumber.toString();
                        lineDetails.oldLineNumber++;
                    } else {
                        lineDetails.oldLineSymbol = '+';
                        lineDetails.lineCls = 'line-add';
                    }
            
                    if (incrementNew) {
                        lineDetails.newLineSymbol = lineDetails.newLineNumber.toString();
                        lineDetails.newLineNumber++;
                    } else {
                        lineDetails.newLineSymbol = '-';
                        lineDetails.lineCls = 'line-remove';
                    }
            
                    lineDetails.lineCls += ' line-code line-idx-' + lineDetails.newLineNumber.toString();
                },
            
                _getLineType: function(line) {
                    var marker = line.substring(0,1);
                    if (marker === '+') {
                        return marker;
                    } else if (marker === '-') {
                        return marker;
                    }
            
                    return '=';
                },
            
                _showAddComment: function(evt, target, options) {
                    // close existing comment
                    if (this.addCommentCmp) {
                        this.addCommentCmp.fireEvent('cancel', this.addCommentCmp);
                    }
            
                    var lineEl = Ext.get(target).up('tr');
                    var afterEl = lineEl;
                    var nextTr = lineEl.dom.nextSibling;
                    while (nextTr && (nextTr.nodeType !== 1 || nextTr.className.match(/line\-comment/))) {
                        afterEl = Ext.fly(nextTr);
                        nextTr = nextTr.nextSibling;
                    }
            
                    var commentEl = Ext.DomHelper.insertAfter(afterEl, {
                        tag: 'tr',
                        cls: 'line-comment',
                        html: '<th colspan="2">comment</th><td><div class="changeset-add-comment"></div></td>'
                    }, true);
                    commentEl.scrollIntoView(commentEl.up('.x-accordion-body'), false);
            
                    this.addCommentCmp = Ext.create('changeset.ui.AddComment', {
                        renderTo: commentEl.down('.changeset-add-comment'),
                        margin: 5,
                        width: this._getCommentWidth(),
                        listeners: {
                            save: Ext.bind(this._onSaveComment, this, [lineEl], true),
                            cancel: this._onCancelComment,
                            afterrender: function() {
                                this.doLayout();
                            },
                            destroy: function() {
                                this.addCommentCmp = null;
                            },
                            scope: this
                        }
                    });
                },
            
                _getCommentWidth: function() {
                    var borderWidth = 1,
                        borderCount = 5,
                        thWidth = 35,
                        thCount = 2,
                        paddingWidth = 5;
                    return this.getWidth() - (borderWidth * borderCount) - (thWidth * thCount) - (paddingWidth * 2);
                },
            
                _onSaveComment: function(cmp, comment, options, lineEl) {
                    cmp.setLoading(true);
            
                    var lineIdx, diffIdx;
                    Ext.each(lineEl.dom.className.split(' '), function(clsName) {
                        var lineMatch = clsName.match(/line\-idx\-(\d+)/),
                            diffMatch = clsName.match(/diff\-idx\-(\d+)/);
                        if (!Ext.isEmpty(lineMatch)) {
                            lineIdx = parseInt(lineMatch[1], 10);
                        } else if (!Ext.isEmpty(diffMatch)) {
                            diffIdx = parseInt(diffMatch[1], 10);
                        }
                    });
            
                    var data = {
                        filename: this.record.get('filename'),
                        revision: this.up('changeset').record.get('revision'),
                        lineIdx: lineIdx,
                        diffIdx: diffIdx,
                        comment: comment
                    };
            
                    this.adapter.saveComment(data, function(record) {
                        var commentEl = cmp.getEl().up('td').insertFirst({tag: 'div', cls: 'changeset-comment'});
                        cmp.destroy();
            
                        Ext.create('changeset.ui.ChangesetSummary', {
                            renderTo: commentEl,
                            width: this._getCommentWidth(),
                            record: record,
                            messageField: 'comment',
                            userField: 'user',
                            userNameField: 'login',
                            revisionField: 'filename',
                            listeners: {
                                afterrender: function() {
                                    this.doLayout();
                                },
                                scope: this
                            }
                        });
                    }, this);
                },
            
                _onCancelComment: function(cmp) {
                    var rowEl = cmp.getEl().up('tr');
                    cmp.destroy();
                    rowEl.destroy();
                    this.doLayout();
                },
            
                _onLineOver: function(evt, target, options) {
                    var el = Ext.get(target);
                    el.on('mouseleave', Ext.bind(this._onLineOut, this, [el]), this, {single: true});
                    el.addCls('line-selected');
            
                    var cellEl = el.down('.line-wrapper');
                    var imgEl = cellEl.insertFirst({
                        tag: 'img',
                        src: 'https://rally1.rallydev.com/slm/js/alm/resources/themes/images/default/feedback/commentbubble.png',
                        cls: 'add-comment-icon'
                    });
            
                    imgEl.on('mouseover', function() {
                        imgEl.addCls('add-comment-icon-selected');
                    });
            
                    imgEl.on('mouseout', function() {
                        imgEl.removeCls('add-comment-icon-selected');
                    });
            
                    imgEl.on('click', this._showAddComment, this);
                },
            
                _onLineOut: function(el) {
                    el.removeCls('line-selected');
                    var imgEl = el.down('.add-comment-icon');
                    if (imgEl) {
                        imgEl.destroy();
                    }
                }
            });            Ext.define('changeset.ui.ChangesetGrid', {
                extend: 'Rally.ui.grid.Grid',
                require: [
                    'Rally.util.Navigation',
                    'Rally.ui.Button'
                ],
                alias: 'widget.changesetgrid',
                cls: 'changeset-grid',
            
                /**
                 * @cfg
                 * @private
                 * 
                 * Artifact type prefix regexes to match in commit messages.
                 */
                artifactRegexes: [
                    /(\s+)(DE\d+)/,
                    /(\s+)(US\d+)/,
                    /(\s+)(TA\d+)/
                ],
            
                columnCfgs: [{
                    header: 'Message',
                    dataIndex: 'message',
                    itemId: 'messageCol',
                    flex: 1,
                    renderer: function(value) {
                        value = Ext.String.htmlEncode(value);
                        Ext.each(this.artifactRegexes, function(artifactRegex) {
                            value = value.replace(artifactRegex, '<a href="#" class="artifact-link">$1$2</a>');
                        });
                        return value;
                    }
                },{
                    xtype: 'templatecolumn',
                    header: 'Author',
                    tpl: '{author.name}',
                    flex: 0.3
                },{
                    xtype: 'datecolumn',
                    header: 'Commit Time',
                    dataIndex: 'timestamp',
                    format: 'Y-m-d h:i:s A',
                    width: 160
                },{
                    header: 'Revision',
                    dataIndex: 'revision',
                    renderer: function(value) {
                        return Ext.String.format('<a href="#" class="revision-link">{0}</a>', value);
                    },
                    width: 85
                }],
            
                buttonAlign: 'center',
                buttons: [{
                    xtype: 'rallybutton',
                    text: 'Load More',
                    itemId: 'loadButton',
                    margin: '10 0 0 0',
                    width: 400
                }],
            
                constructor: function(config) {
                    config = config || {};
                    Ext.applyIf(config, {
                        columnCfgs: this.columnCfgs,
                        showPagingToolbar: false
                    });
                    this.callParent([config]);
                },
            
                initComponent: function() {
                    this.callParent(arguments);
                    this.addEvents(
                        /**
                         * @event
                         * fired when a revision is clicked.
                         * @param {changeset.model.Commit}
                         */
                        'revisionClicked',
                        /**
                         * @event
                         * fired when an artifact is clicked.
                         * @param {String}
                         */
                        'artifactClicked'
                    );
            
                    this.on('render', this._onRender, this);
                    this.down('#loadButton').on('click', this._loadMore, this);
                    this.mon(this.store, 'load', this._onStoreLoad, this);
                    this.mon(this.store, 'datachanged', this._onStoreDataChanged, this);
                },
            
                /**
                 * Set the filter value.
                 * 
                 * @param value {String} The value to filter for or {null} for no filter.
                 */
                setCommitFilter: function(value) {
                    var store = this.store;
                    this.filteredRowCount = null;
                    if (Ext.isEmpty(value)) {
                        this.commitFilter = null;
                        store.clearFilter();
                    } else {
                        var regex = new RegExp(value, 'i');
                        this.commitFilter = {
                            filterFn: function(record) {
                                if (regex.test(record.get('message'))) {
                                    return true;
                                } else if (regex.test(record.get('author').name)) {
                                    return true;
                                } else if (regex.test(record.get('revision'))) {
                                    return true;
                                }
            
                                return false;
                            }
                        };
            
                        store.clearFilter(true);
                        store.filter(this.commitFilter);
                    }
                },
            
                _loadMore: function() {
                    if (this.down('#loadButton')) {
                        var store = this.store;
                        store.clearFilter(true);
                        store.nextPage();
                    }
                },
            
                _onRender: function() {
                    var el = this.getEl();
                    el.on('click', this._onArtifactClick, this, {delegate: 'a.artifact-link'});
                    el.on('click', this._onRevisionClick, this, {delegate: 'a.revision-link'});
                },
            
                _onArtifactClick: function(event, dom, opts) {
                    this.fireEvent('artifactClicked', dom.innerHTML);
                },
            
                _onRevisionClick: function(event, dom) {
                    var record = this.store.findRecord('revision', dom.innerHTML);
                    this.fireEvent('revisionClicked', record);
                },
            
                _onStoreLoad: function(store, records) {
                    // Scroll to first new row.
                    if (records.length > 0) {
                        var rowIdx = store.indexOf(records[0]);
                        if (rowIdx) {
                            this.getView().focusRow(rowIdx);
                        }
                    }
            
                    // If the count is less than the pagesize we've run out of pages.
                    var pageSize = store.pageSize;
                    if (store.currentPage > 1) {
                        pageSize--;
                    }
                    if (records.length < pageSize) {
                        this.down('#loadButton').destroy();
                    }
            
                    if (this.commitFilter) {
                        store.filter(this.commitFilter);
                    }
                },
            
                _onStoreDataChanged: function() {
                    var store = this.store;
                    if (store.isFiltered()) {
                        var filteredRowCount = store.data.getCount();
                        if (filteredRowCount < 1 || (this.filteredRowCount && this.filteredRowCount >= filteredRowCount)) {
                            this._loadMore();
                        }
                        this.filteredRowCount = filteredRowCount;
                    }
                }
            });            Ext.define('changeset.ui.ChangesetFilesGrid', {
                extend: 'Rally.ui.grid.Grid',
                alias: 'widget.changesetfilesgrid',
                cls: 'changeset-files-grid',
                storeConfig: {
                    fetch: true,
                    sorters: [{
                        property: 'filename',
                        direction: 'ASC'
                    }]
                },
                columnCfgs: [{
                    header: 'Status',
                    dataIndex: 'status',
                    renderer: function(value) {
                        return Ext.String.capitalize(value.substring(0,3));
                    },
                    width: 50
                },{
                    header: 'File',
                    xtype: 'templatecolumn',
                    tpl: '<a href="#" class="file-name">{filename}</a>',
                    flex: 1,
                    listeners: {
                        click: function(target, dom, index) {
                            Ext.query('.changeset-file-diff')[index].scrollIntoView();
                        }
                    }
                },{
                    header: 'Changes',
                    dataIndex: 'changes',
                    width: 65
                },{
                    header: 'Additions',
                    dataIndex: 'additions',
                    width: 65
                },{
                    header: 'Deletions',
                    dataIndex: 'deletions',
                    width: 65
                }],
            
                constructor: function(config) {
                    config = config || {};
                    Ext.applyIf(config, {
                        columnCfgs: this.columnCfgs,
                        storeConfig: this.storeConfig,
                        showPagingToolbar: false
                    });
                    
                    this.callParent([config]);
                }
            });            Ext.define('changeset.ui.ChangesetSummary', {
                extend: 'Ext.panel.Panel',
                alias: 'widget.changesetsummary',
                cls: 'changeset-summary',
                frame: true,
                
                /**
                 * @cfg
                 */
                messageField: 'message',
                
                /**
                 * @cfg
                 */
                avatarField: 'avatarUrl',
                
                /**
                 * @cfg
                 */
                userField: 'author',
                
                /**
                 * @cfg
                 */
                userNameField: 'name',
                
                /**
                 * @cfg
                 */
                timestampField: 'timestamp',
                
                /**
                 * @cfg
                 */
                revisionField: 'revision',
                
                dockedItems: [{
                    xtype: 'toolbar',
                    itemId: 'bottomToolbar',
                    dock: 'bottom',
                    border: 0
                }],
            
                initComponent: function() {
                    this.callParent(arguments);
                    this._initItems();
                },
                
                _initItems: function() {
                    if (!this.record) {
                        return;
                    }
            
                    this.html = '<p>' + this.record.get(this.messageField) + '</p>';
            
                    var toolbar = this.getComponent('bottomToolbar');
                    if (!Ext.isEmpty(this.record.get(this.avatarField))) {
                        toolbar.add([{
                           margin: '2 6 2 2',
                           xtype: 'changesetavatar',
                           record: this.record,
                           width: 40,
                           height: 40
                       }]);
                    }
            
                    toolbar.add([
                        {
                            html: this.record.get(this.userField)[this.userNameField]
                        },{
                            html: Ext.Date.format(new Date(this.record.get(this.timestampField)), 'Y-m-d h:i:s A')
                        },{
                            html: this.record.get(this.revisionField)
                        }
                    ]);
                }
            });
            Ext.define('changeset.ui.Changeset', {
                extend: 'Ext.panel.Panel',
                require: [
                    'changeset.data.CommentLocator',
                    'changeset.ui.ChangesetSummary',
                    'changeset.ui.ChangesetFileDiff',
                    'changeset.ui.ChangesetFilesGrid'
                ],
                alias: 'widget.changeset',
                cls: 'changeset',
            
                /**
                 * @cfg
                 */
                adapter: null,
            
                initComponent: function() {
                    this.callParent(arguments);
                    this.on('afterrender', this._renderChangeset, this, {single: true});
                },
            
                _renderChangeset: function() {
                    if (!this.record) {
                        return;
                    }
            
                    this.add({
                        xtype: 'changesetsummary',
                        margin: 10,
                        border: 0,
                        record: this.record
                    });
            
                    this._loadComments();
                },
                
                _loadComments: function() {
                    this.adapter.getCommentStore(this.record, function(store) {
                        store.on('load', this._onCommentStoreLoad, this);
                        this.up('panel').setLoading(true, true);
                        store.load();
                    }, this);
                },
                
                _onCommentStoreLoad: function(store) {
                    var commentLocator = new changeset.data.CommentLocator(store);
                    this.adapter.getChangesetStore(this.record, function(store) {
                        if (!store) {
                            return;
                        }
                        
                        var callback = Ext.bind(this._onChangesetStoreLoad, this, [commentLocator], true);
                        this.mon(store, 'load', callback, this, {single: true});
                        store.load();
                    }, this);
                },
            
                _onChangesetStoreLoad: function(store, records, scope, opts, commentLocator) {
                    var grid = this.insert( 1,
                        {
                            xtype: 'changesetfilesgrid',
                            margin: 10,
                            border: 0,
                            store: store
                        }
                    );
            
                    var addedCount = 0;
                    store.each(function(record) {
                        var task = new Ext.util.DelayedTask(function() {
                            this.add({
                                xtype: 'changesetfilediff',
                                margin: 10,
                                border: 0,
                                adapter: this.adapter,
                                record: record,
                                commentLocator: commentLocator,
                                listeners: {
                                    afterrender: {
                                        fn: function() {
                                            addedCount++;
                                            if (addedCount === store.count()) {
                                                //prettyPrint(); disabled until we can get this working.
                                                this.up('panel').setLoading(false);
                                            }
                                        },
                                        single: true
                                    },
                                    scope: this
                                }
                            });
                        }, this);
                        task.delay(10);
                    }, this);
                }
            });            Ext.define('changeset.ui.ChangesetBrowser', {
                extend: 'Ext.panel.Panel',
                alias: 'widget.changesetbrowser',
                require: [
                    'changeset.ui.ChangesetGrid',
                    'changeset.ui.Changeset',
                    'changeset.ui.ChangesetFilter',
                    'Rally.ui.ComboBox',
                    'Rally.ui.tooltip.ToolTip'
                ],
                cls: 'changeset-browser',
                border: 0,
                bodyBorder: false,
            
                layout: {
                    type: 'accordion',
                    animate: true
                },
            
                /**
                 * @cfg
                 */
                adapter: null,
            
                initComponent: function() {
                    this.callParent(arguments);
                    this._populateToolbar();
                },
            
                _populateToolbar: function() {
                    this.addDocked({
                        itemId: 'topToolbar',
                        dock: 'top',
                        border: 0,
                        padding: 5,
                        layout: 'hbox',
                        items: [{
                            xtype: 'rallybutton',
                            text: 'Logout',
                            margin: '0 5 0 0 ',
                            handler: function() {
                                this.adapter.logout();
                            },
                            scope: this
                        }]
                    });
            
                    this._addRepoChooser();
                },
            
                _addFilter: function() {
                    if (this.down('changesetfilter')) {
                        return;
                    }
            
                    var toolbar = this.down('#topToolbar');
                    var filter = toolbar.insert(3, {
                        xtype: 'changesetfilter',
                        width: 210,
                        listeners: {
                            filter: this._onFilter,
                            afterrender: function(cmp) {
                                var tip = Ext.create('Rally.ui.tooltip.ToolTip', {
                                    target: cmp.getEl(),
                                    anchor: 'right',
                                    html: 'Filter commits by: <br /> <ul><li>-- message</li><li>-- author</li><li>-- revision</li></ul>'
                                });
                            },
                            scope: this
                        }
                    });
                },
            
                _addRepoChooser: function() {
                    var toolbar = this.down('#topToolbar');
                    var valueField = 'name';
                    this.adapter.getRepositoryStore(function(store) {
                        var combo = toolbar.insert(1, {
                            xtype: 'rallycombobox',
                            margin: '0 5 0 0',
                            store: store,
                            fieldLabel: 'Repository:',
                            labelWidth: 60,
                            displayField: valueField,
                            listeners: {
                                beforeselect: function(combo, record) {
                                    if (record && record.get('name') !== this.adapter.getRepository().name) {
                                        this._onRepositorySelect(record);
                                    }
                                },
                                scope: this
                            }
                        });
            
                        store.on('load', function() {
                            var repo = this.adapter.getRepository();
                            var selectedRepo = repo ? store.findRecord('name', repo.name) : store.getAt(0);
                            combo.select(selectedRepo);
                            this._onRepositorySelect(selectedRepo);
                        }, this, {single: true});
                        store.load();
                    }, this);
                },
            
                _onRepositorySelect: function(repository) {
                    this.adapter.setRepository(repository);
                    this.removeAll();
                    this._addBranchChooser();
                },
            
                _addBranchChooser: function() {
                    var toolbar = this.down('#topToolbar');
                    var combo = toolbar.down('#branchChooser');
                    if (combo) {
                        toolbar.remove(combo);
                    }
            
                    var valueField = 'name';
                    this.adapter.getBranchStore(function(store) {
                        combo = toolbar.insert(2, {
                            xtype: 'rallycombobox',
                            itemId: 'branchChooser',
                            margin: '0 5 0 0',
                            store: store,
                            fieldLabel: 'Branch:',
                            labelWidth: 40,
                            displayField: valueField,
                            listeners: {
                                beforeselect: function(combo, record) {
                                    if (record && record.get('name') !== this.adapter.getBranch().name) {
                                        this._onBranchSelect(record);
                                    }
                                },
                                scope: this
                            }
                        });
            
                        store.on('load', function() {
                            var branch = this.adapter.getBranch();
                            var selectedBranch = branch ? store.findRecord('name', branch.name) : store.getAt(0);
                            combo.select(selectedBranch);
                            this._onBranchSelect(selectedBranch);
                        }, this, {single: true});
                        store.load();
                    }, this);
                },
            
                _onBranchSelect: function(branch) {
                    this.adapter.setBranch(branch);
                    this.removeAll();
                    this._addFilter();
                    this._addGrid();
                },
            
                _addGrid: function() {
                    var callback = function(store) {
                        var grid = this.add({
                            xtype: 'changesetgrid',
                            itemId: 'changeSetGrid',
                            margin: '10 0 0 0',
                            autoScroll: true,
                            model: 'changeset.model.Commit',
                            store: store
                        });
                        store.load();
                        grid.setTitle('Commits');
                        grid.expand();
                        this.mon(grid, 'artifactClicked', this._showArtifact, this);
                        this.mon(grid, 'revisionClicked', this._showRevision, this);
                    };
                    this.adapter.getCommitStore(callback, this);
                },
            
                _showArtifact: function(formattedId) {
                    Ext.data.JsonP.request({
                        url: Rally.environment.getServer().getWsapiUrl() + '/artifact.js',
                        method: 'GET',
                        callbackKey: 'jsonp',
                        params: {
                            query: '(FormattedID = ' + formattedId + ')'
                        },
                        success: this._onFormattedIdLoad,
                        scope: this
                    });
                },
            
                _onFormattedIdLoad: function(result) {
                    if (result.QueryResult) {
                        var results = result.QueryResult.Results;
                        if (results && results.length) {
                            var ref = results[0]._ref;
                            var detailLink = Rally.util.Navigation.createRallyDetailUrl(ref);
                            window.open(detailLink, 'detailpage');
                        }
                    }
                },
            
                _showRevision: function(record) {
                    if (this.items.getCount() > 1) {
                        this.remove(this.items.getAt(1));
                    }
                    var revision = this.add({
                        xtype: 'changeset',
                        adapter: this.adapter,
                        title: 'Revision: ' + record.get('revision'),
                        autoScroll: true,
                        record: record
                    });
                    revision.expand();
                },
            
                _onFilter: function(value) {
                    var grid = this.down('#changeSetGrid');
                    if (grid) {
                        grid.setCommitFilter(value);
                    }
                }
            });            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                require: [
                    'Ext.state.Manager',
                    'Ext.state.LocalStorageProvider',
                    'Ext.state.CookieProvider',
                    'changeset.data.github.Adapter',
                    'changeset.ui.ChangesetBrowser'
                ],
                componentCls: 'app',
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
            
                launch: function() {
                    var provider;
                    try {
                        provider = Ext.create('Ext.state.LocalStorageProvider');
                    } catch (e) {
                        provider = Ext.create('Ext.state.CookieProvider');
                    }
                    Ext.state.Manager.setProvider(provider);
            
                    this.adapter = Ext.create('changeset.data.github.Adapter', {
                        listeners: {
                            ready: this._onAdapterReady,
                            authenticationrequired: this._onAuthenticationRequired,
                            scope: this
                        }
                    });
                },
            
                _onAdapterReady: function(adapter) {
                    this.removeAll();
                    this.add({
                        xtype: 'changesetbrowser',
                        margin: '0 5 5 5',
                        border: 0,
                        adapter: adapter,
                        flex: 1
                    });
                },
            
                _onAuthenticationRequired: function(adapter) {
                    this.removeAll();
                    this.add({
                        flex: 1,
                        border: 0,
                        adapter: adapter,
                        items: [{
                            xtype: 'changesetlogin',
                            border: 0,
                            adapter: adapter
                        }]
                    });
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'RallyGithub'
            });
        });
    </script>

    <style type="text/css">
        .pln{color:#000}@media screen{.str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun,.opn,.clo{color:#660}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec,.var{color:#606}.fun{color:red}}@media print,projection{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun,.opn,.clo{color:#440}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}pre.prettyprint{padding:2px;border:1px solid #888}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style-type:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}        .changeset-add-comment {
            border-color: #999;
        }
        
        .changeset-add-comment .x-panel, .changeset-add-comment .x-panel-body {
            background-color: #eee
        }        .changeset-file-diff {
            margin-top: 16px;
            border: 1px solid #aaa;
        }
        
        .changeset-file-diff table .prettyprint {
            border: 0;
        }
        
        .changeset-file-diff table {
            width: 100%;
        }
        
        .changeset-file-diff tr td, .changeset-file-diff tr th {
            padding: 2px;
            font-size: 10px;
        }
        
        .changeset-file-diff tr th {
            text-align: right;
            background-color: #eee;
            border-right: 1px solid #aaa;
            width: 35px;
        }
        
        .changeset-file-diff .x-toolbar.x-docked-top {
            background-color: #eee;
        }
        
        .changeset-file-diff .x-toolbar.x-docked-top .x-toolbar-item {
            background: transparent;
            font-size: 16px;
            cursor: default;
        }
        
        .changeset-file-diff .line-add, .changeset-file-diff .line-add th {
            background-color: #DFD;
        }
        
        .changeset-file-diff .line-remove, .changeset-file-diff .line-remove th {
            background-color: #FDD;
        }
        
        .changeset-file-diff .line-diff, .changeset-file-diff .line-diff th {
            background-color: #DDF;
        }
        
        .changeset-file-diff .line-comment, .changeset-file-diff .line-comment th {
            background-color: #fff9b1;
        }
        
        .changeset-file-diff .line-comment {
            border: 1px solid #aaa;
            border-left: 0;
            border-right: 0;
        }
        
        .changeset-file-diff .line-comment th {
            font-size: 12px;
        }
        
        .changeset-comment {
            margin: 5px;
        }
        
        .changeset-comment .changeset-summary .x-panel-body {
            border: 0;
        }
        
        .changeset-file-diff .line-selected, .changeset-file-diff .line-selected th {
            background: #eff8fb;
        }
        
        .changeset-file-diff .line-wrapper {
            position: relative;
        }
        
        .changeset-file-diff .add-comment-icon {
            position: absolute;
            top: 2px;
            left: 1px;
        }
        
        .changeset-file-diff .add-comment-icon-selected {
            cursor: pointer;
        }        .changeset-login {
            margin: 10px auto;
        }
        
        .changeset-login .login-message {
            font-size: 14px;
        }        .changeset-browser-title .x-panel-body {
            font-size: 18px;
        }        .changeset-files-grid .x-panel-body {
            border-bottom: 1px solid #999;
            border-top: 1px solid #999 !important;
        }
        .changeset-summary, .changeset-summary .x-panel-body {
            background-color: #eee;
        }
        
        .changeset-summary {
            border-color: #999;
        }
        
        .changeset-summary p {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .changeset-summary .x-toolbar-docked-bottom {
            border: 0;
            background-color: transparent;
        }
        
        .changeset-summary .x-toolbar-docked-bottom .x-toolbar-item {
            background-color: #aaa;
            font-size: 12px;
        }
        
        .changeset-summary .x-toolbar-docked-bottom .x-toolbar-item:hover {
            cursor: default;
        }        .app .x-panel-body-default {
            font-size: 14px;
        }
        
        .app .x-panel-header-text {
            font-size: 14px;
        }
        
        .app .x-grid-cell-inner, .app .x-column-header-text {
            margin: 4px 2px;
            font-size: 12px;
        }
    </style>
</head>
<body></body>
</html>
